{ config, pkgs, ... }:

let
  isNixOS = builtins.pathExists "/etc/NIXOS";
  fileDir = builtins.toString ./.;
  wallpaper = "/home/gabriel/Pictures/wallpapers/share/dark/anime-girl-office.jpg";
in
{
  imports = [ <home-manager/nixos> ];

  home-manager = {
    useGlobalPkgs = isNixOS;
    backupFileExtension = "back";
    users.gabriel = { ... }: {
      imports = [ <plasma-manager/modules> ];

      targets.genericLinux.enable = ! isNixOS;

      programs = {
        direnv = {
          enable = true;
          nix-direnv.enable = true;
        };

        bash = {
          enable = true;
          enableCompletion = true;
          bashrcExtra = ''
            eval "$(direnv hook bash)"
          '';
          shellAliases = {
            grep = "grep --color=tty";
            music-dl = "yt-dlp -i -x --audio-format mp3";
            clang-format-all = "find . -name '*.[c,h]' -exec clang-format -i {} \;";
          };
        };

        git = {
          enable = true;
          userEmail = "gabrielgbrito@icloud.com";
          userName = "Gabriel G. de Brito";
          extraConfig = {
            advice.addEmptyPathspec = false;
            init.defaultBranch = "main";
            format.pretty = "oneline";
            receive.denyCurrentBranch = "warn";
          };
        };

        tmux = {
          enable = true;
          escapeTime = 0;
          mouse = true;
          extraConfig = ''
            set -ag terminal-overrides ",xterm-256color:RGB"
            set  -g default-terminal "tmux-256color"
          '';
        };

        konsole = {
          enable = true;
          defaultProfile = "Profile 1";
          customColorSchemes.FlatUI = ./FlatUI.colorscheme;
          profiles."Profile 1" = {
            colorScheme = "FlatUI";
            font = {
              size = 10;
              name = "Fragment Mono";
            };
            extraConfig = {
              General = {
                SemanticInputClick = true;
                TerminalColumns = 90;
                TerminalRows = 28;
              };
              Scrolling = {
                HighlightScrolledLines = false;
                ScrollBarPosition = 2;
              };
            };
          };
          extraConfig = {
            "Interaction Options" = {
              OpenLinksByDirectClickEnabled = true;
              TextEditorCmd = 1;
            };
            "Konsole Window" = {
              AllowMenuAccelerators = false;
              RememberWindowSize = false;
              ShowWindowTitleOnTitleBar = true;
            };
            MainWindow = {
              ToolBarsMovable = "Disabled";
            };
          };
        };

        okular = {
          enable = true;
          accessibility.highlightLinks = false;
          general = {
            obeyDrm = false;
            openFileInTabs = false;
            showScrollbars = true;
            smoothScrolling = true;
            viewContinuous = true;
            zoomMode = "fitWidth";
          };
        };

        # By nature, there's device specific configuration removed from this
        # file. Because of that, we cannot use that setting that "ensures
        # reproducibility". By the way, this was generated by rc2nix.py.
        plasma = {
          enable = true;
          shortcuts = {
            kwin = {
              "Peek at Desktop" = "Meta+D";
              "Polonium: Insert Below" = "Meta+Shift+Down";
              "Polonium: Insert Above" = "Meta+Shift+Up";
              "Polonium: Insert Left" = "Meta+Left";
              "Polonium: Insert Right" = "Meta+Right";
              "Polonium: Retile Window" = "Meta+Space";
              "Switch to Desktop 1" = "Meta+1";
              "Switch to Desktop 2" = "Meta+2";
              "Switch to Desktop 3" = "Meta+3";
              "Switch to Desktop 4" = "Meta+4";
              "Window to Desktop 1" = "Meta+Shift+1";
              "Window to Desktop 2" = "Meta+Shift+2";
              "Window to Desktop 3" = "Meta+Shift+3";
              "Window to Desktop 4" = "Meta+Shift+4";
            };
            "services/org.kde.konsole.desktop" = {
              _launch = "Meta+Return";
            };
          };
          kwin = {
            virtualDesktops.number = 4;
            tiling.padding = 15;
            scripts.polonium = {
              enable = true;
              settings = {
                borderVisibility = "borderAll";
                layout = {
                  engine = "binaryTree";
                  insertionPoint = "left";
                };
              };
            };
          };
          panels = [
            {
              location = "top";
              height = 25;
              widgets = [
                {
                  kickoff = {
                    sortAlphabetically = true;
                    icon = "nix-snowflake-white";
                    label = "Menu ";
                  };
                }
                {
                  pager = {};
                }
                {
                  iconTasks = {
                    launchers = [];
                    behavior = {
                      grouping = {
                        clickAction = "showPresentWindowsEffect";
                        method = "none";
                      };
                    };
                  };
                }
                "org.kde.plasma.marginsseparator"
                {
                  systemMonitor = {
                    displayStyle = "org.kde.ksysguard.textonly";
                    sensors = [
                      {
                        name = "cpu/all/maximumTemperature";
                        label = "CPU";
                        color = "189,233,61";
                      }
                    ];
                  };
                }
                "org.kde.plasma.systemtray"
                "org.kde.plasma.digitalclock"
              ];
            }
          ];
          powerdevil = rec {
            AC = {
              autoSuspend.action = "nothing";
              dimDisplay.enable = false;
              whenLaptopLidClosed = "turnOffScreen";
            };
            battery = AC;
            lowBattery = AC;
          };
          workspace = {
            lookAndFeel = "org.kde.breezedark.desktop";
            wallpaper = wallpaper;
          };
          configFile = {
            baloofilerc."Basic Settings".Indexing-Enabled = false;
            dolphinrc = {
              ContextMenu = {
                ShowAddToPlaces = false;
                ShowCopyToOtherSplitView = false;
                ShowOpenInNewTab = false;
                ShowOpenInSplitView = false;
                ShowSortBy = false;
              };
              General = {
                AutoExpandFolders = true;
                RememberOpenedTabs = false;
                ShowFullPathInTitlebar = true;
              };
            };
            kded5rc = {
              Module-browserintegrationreminder.autoload = false;
              Module-device_automounter.autoload = false;
            };
            kdeglobals = {
              KDE.ShowDeleteCommand = true;
              "KFileDialog Settings" = {
                "Allow Expansion" = false;
                "Breadcrumb Navigation" = true;
                "Show Bookmarks" = false;
                "Show Full Path" = false;
                "Show Inline Previews" = true;
                "Show Preview" = false;
                "Show Speedbar" = true;
                "Sort by" = "Name";
                "Sort directories first" = true;
                "Sort hidden files last" = true;
              };
              WM.activeFont = "TeX Gyre Heros,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
              General = {
                fixed = "Fragment Mono,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
                font = "TeX Gyre Heros,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
                menuFont = "TeX Gyre Heros,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
                smallestReadableFont = "TeX Gyre Heros,8,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
                toolBarFont = "TeX Gyre Heros,10,-1,5,400,0,0,0,0,0,0,0,0,0,0,1";
              };
            };
            kiorc = {
              Confirmations = {
                ConfirmDelete = true;
                ConfirmEmptyTrash = true;
                ConfirmTrash = false;
              };
              "Executable scripts".behaviourOnLaunch = "alwaysAsk";
            };
            krunnerrc.Plugins = {
              baloosearchEnabled = false;
              browserhistoryEnabled = false;
              browsertabsEnabled = false;
              calculatorEnabled = false;
              helprunnerEnabled = false;
              krunner_charrunnerEnabled = false;
              krunner_katesessionsEnabled = false;
              krunner_konsoleprofilesEnabled = false;
              krunner_placesrunnerEnabled = false;
              krunner_plasma-desktopEnabled = false;
              krunner_recentdocumentsEnabled = false;
              krunner_sessionsEnabled = false;
              krunner_spellcheckEnabled = false;
              krunner_webshortcutsEnabled = false;
              locationsEnabled = false;
              "org.kde.activities2Enabled" = false;
              "org.kde.datetimeEnabled" = false;
              windowsEnabled = false;
            };
            kscreenlockerrc = {
              Daemon.Autolock = false;
              "Greeter/Wallpaper/org.kde.image/General" = {
                Image = wallpaper;
                PreviewImage = wallpaper;
              };
            };
            kservicemenurc.Show = {
              compressfileitemaction = true;
              decrypt-view = true;
              encrypt = true;
              extractfileitemaction = true;
              forgetfileitemaction = false;
              installFont = false;
              kactivitymanagerd_fileitem_linking_plugin = true;
              kio-admin = true;
              kleodecryptverifyfiles = true;
              kleoencryptfiles = true;
              kleoencryptfolder = true;
              kleoencryptsignfiles = true;
              kleosignencryptfolder = true;
              kleosignfilescms = true;
              kleosignfilesopenpgp = true;
              makefileactions = false;
              mountisoaction = true;
              runInKonsole = false;
              slideshowfileitemaction = false;
              tagsfileitemaction = false;
              wallpaperfileitemaction = true;
            };
            ktrashrc."\\/home\\/gabriel\\/.local\\/share\\/Trash" = {
              Days = 7;
              LimitReachedAction = 2;
              Percent = 2;
              UseSizeLimit = true;
              UseTimeLimit = true;
            };
            kwalletrc.Wallet."First Use" = false;
            kwinrc.Xwayland.Scale = 1;
            plasma-localerc.Formats.LANG = "en_DK.UTF-8";
          };
        };
      };

      gtk = {
        enable = true;
        theme.name = "Breeze-Dark";
      };

      home.file = {
        ".local/bin/mknix" = {
          enable = true;
          executable = true;
          source = ./bin/mknix;
        };

        ".local/bin/acme" = {
          enable = true;
          executable = true;
          source = ./bin/acme;
        };

        ".local/bin/9term" = {
          enable = true;
          executable = true;
          source = ./bin/9term;
        };

        ".local/bin/sam" = {
          enable = true;
          executable = true;
          source = ./bin/sam;
        };

        ".local/bin/9env" = {
          enable = true;
          executable = true;
          source = ./bin/9env;
        };

        ".config/micro/settings.json" = {
          enable = true;
          source = ./micro/settings.json;
        };

        ".config/micro/bindings.json" = {
          enable = true;
          source = ./micro/bindings.json;
        };
      };

      home.stateVersion = config.system.stateVersion;
    };
  };
}
